{{- $serviceAccountName := .Values.serviceAccount | default (include "appname" .) }}
{{- $existingServiceAccount := lookup "v1" "ServiceAccount" .Release.Namespace $serviceAccountName }}

{{- if not $existingServiceAccount }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $serviceAccountName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
    {{- include "sa.annotations" . | nindent 4 }}
{{- end }}

---

{{- if .Values.linked_service.enabled }}
{{- $linkedServiceAccountName := .Values.linked_service.parameters.serviceAccountName }}
{{- if $linkedServiceAccountName }}
{{- $existingLinkedServiceAccount := lookup "v1" "ServiceAccount" .Release.Namespace $linkedServiceAccountName }}
{{- if not $existingLinkedServiceAccount }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $linkedServiceAccountName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
    {{- include "sa.linked_service.annotations" . | nindent 4 }}
{{- end }}
{{- end }}
{{- end }}
